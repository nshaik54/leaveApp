/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["hcm/fab/myleaverequest/utils/utils","hcm/fab/myleaverequest/utils/formatters","hcm/fab/lib/common/util/TeamCalendarDataManager","jquery.sap.storage","sap/ui/Device","hcm/fab/myleaverequest/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/routing/History","sap/ui/unified/DateRange","sap/ui/unified/DateTypeRange","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessagePopover","sap/m/MessagePopoverItem"],function(u,f,T,s,D,B,F,a,H,b,c,J,M,d,e){"use strict";return B.extend("hcm.fab.myleaverequest.controller.Overview",{oODataModel:null,oDialog:null,previousRange:null,CALENDARPERSKEY:"showCalendar",ENTITLEMENTSPERSKEY:"expandEntitlements",OVERVIEWPERSKEY:"expandOverview",oStorage:jQuery.sap.storage(jQuery.sap.storage.Type.local),_refresh:false,_oQuickView:undefined,_oMessagePopover:null,sCEEmployeeId:undefined,formatter:f,onInit:function(){var l=new J({showCalendar:!!this.oStorage.get(this.CALENDARPERSKEY),viewSelection:this.oStorage.get(this.CALENDARPERSKEY)?"calendar":"list",entCount:0,overviewCountText:this.getResourceBundle().getText("items","0"),entitlementsExpanded:!!this.oStorage.get(this.ENTITLEMENTSPERSKEY),overviewExpanded:!!this.oStorage.get(this.OVERVIEWPERSKEY),calendarBusy:false});this.setModel(l,"local");this.oODataModel=this.getOwnerComponent().getModel();this.oErrorHandler=this.getOwnerComponent().getErrorHandler();this._oTeamCalendarDataManager=new T();var C=Promise.resolve();var t=this;var g=this.oODataModel.metadataLoaded();var E=this.getOwnerComponent().getAssignmentId();Promise.all([g,C,E]).then(function(j){t.onMetaDataLoaded(j[2]);}).catch(function(o){var j=o;});var S=l.getProperty("/showCalendar");this._toggleCalendarModel(S);var h=l.getProperty("/entitlementsExpanded");this._toggleEntitlements(h);var i=l.getProperty("/overviewExpanded");this._toggleOverview(i);this.getRouter().getRoute("overview").attachPatternMatched(this._onRouteMatched,this);sap.ui.getCore().getEventBus().subscribe("hcm.fab.myleaverequest","invalidateoverview",function(){this._refresh=true;},this);this.getView().byId("quotaUsedColTxt").addStyleClass(D.system.desktop?"sapUiLargeMarginEnd":undefined);this.getView().byId("quotaUsedCell").addStyleClass(D.system.desktop?"sapMTableContentMargin sapUiLargeMarginEnd":"sapMTableContentMargin");},onExit:function(){this.oErrorHandler.clearErrors();if(this._oQuickView){this._oQuickView.destroy();this._oQuickView=undefined;}},onMetaDataLoaded:function(E){this._initOverviewModelBinding(E);this.sCEEmployeeId=E;},onEntitlementDateChanged:function(E){var g=[];var C=E.getSource();var q=u.dateToUTC(C.getDateValue());var t=this.getView().byId("entitlementTable");var h=t.getBinding("items");if(q){g.push(new F("FilterStartDate",a.GE,q));g.push(new F("EmployeeID",a.EQ,this.sCEEmployeeId));h.filter(g,"Application");}else{h.filter(null);}},onUpdateFinishedEntitlements:function(E){this.getModel("local").setProperty("/entCount",E.getParameter("total"));},onUpdateFinishedOverview:function(E){this.getModel("local").setProperty("/overviewCountText",this.getResourceBundle().getText("items",E.getParameter("total")));},onCreateLeave:function(){var C=this.getView().byId("calendar");var S=C.getSelectedDates();var r=this.getRouter();if(S.length===0){r.navTo("creation");}else{var g=S[0];var o=g.getStartDate();var h=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate()));C.destroySelectedDates();r.navTo("creationWithParams",{dateFrom:""+u.dateToUTC(h).getTime(),dateTo:""+u.dateToUTC(h).getTime(),absenceType:"default",sEmployeeID:this.sCEEmployeeId});}},onClose:function(){this.oDialog.close();},onItemPressed:function(E){var C=E.getParameter("listItem").getBindingContext();var p=C.getPath().substr(1);var r=this.getRouter();r.navTo("display",{leavePath:p});},onEntitlementItemPressed:function(E){var C=E.getParameter("listItem").getBindingContext();if(!this._oQuickView){this._oQuickView=sap.ui.xmlfragment("hcm.fab.myleaverequest.view.fragments.EntitlementDetail",this);this.getView().addDependent(this._oQuickView);}this._oQuickView.setBindingContext(C);this._oQuickView.openBy(E.getSource());},onHandlePopover:function(E){var m=E.getSource(),v=this.getView();if(!this._oMessagePopover){this._oMessagePopover=new d({items:{path:"message>/",template:new e({description:"{message>description}",type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}"})}});jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),v,this._oMessagePopover);v.addDependent(this._oMessagePopover);}this._oMessagePopover.toggle(m);},onNavBack:function(){this.oErrorHandler.clearErrors();var p=H.getInstance().getPreviousHash(),C=sap.ushell.Container.getService("CrossApplicationNavigation");if(p!==undefined||!C.isInitialNavigation()){history.go(-1);}else{C.toExternal({target:{shellHash:"#"}});}},onDeleteSwipe:function(E){this._deleteRequest(E.getSource().getParent().getSwipedItem());},onDeletePress:function(E){var l=E.getSource(),i=E.getSource().getParent(),C=this.getOwnerComponent();M.confirm(this.getResourceBundle().getText("confirmDeleteMessage"),{styleClass:C.getContentDensityClass(),initialFocus:M.Action.CANCEL,onClose:function(A){if(A===M.Action.OK){l.attachEventOnce("updateFinished",l.focus,l);this._deleteRequest(i);}}.bind(this)});},onEditPress:function(E){var r=this.getRouter();var p=E.getSource().getBindingContext().getPath();r.navTo("edit",{leavePath:p.substr(1)});},onStartDateChange:function(E){var g=[];var C=E.getSource();var n=u.dateToUTC(C.getDateValue());var o=this.getView().byId("leaveRequestTable").getBinding("items");if(n){g.push(new F("StartDate",a.GE,n));g.push(new F("EmployeeID",a.EQ,this.sCEEmployeeId));o.filter(g,"Application");}else{o.filter(null);}},onDateSelect:function(E){var g=E.getSource();var h=g.getSelectedDates();var i=h[0];var S=i.getStartDate();var o=new Date(Date.UTC(S.getFullYear(),S.getMonth(),S.getDate()));var j=i.getEndDate();var k;if(j){k=new Date(Date.UTC(j.getFullYear(),j.getMonth(),j.getDate()));}var r=this.getRouter();var l=[];if(o&&!k){l=g.getSpecialDates().filter(function(v){return v.getStartDate()<=o&&v.getEndDate()>=o;});}switch(l.length){case 0:if(k){g.destroySelectedDates();r.navTo("creationWithParams",{dateFrom:""+u.dateToUTC(o).getTime(),dateTo:""+u.dateToUTC(k).getTime(),absenceType:"default",sEmployeeID:this.sCEEmployeeId});}break;case 1:default:g.destroySelectedDates();r.navTo("display",{leavePath:l[0].data("path")});break;}},onAssignmentSwitch:function(E){this.sCEEmployeeId=E.getParameter("selectedAssignment");this.getOwnerComponent().setAssignmentId(this.sCEEmployeeId);this._initOverviewModelBinding(this.sCEEmployeeId);},onSelect:function(E){var S=E.getParameter("key");if(S==="calendar"||S==="list"){this._toggleCalendarModel(S==="calendar");this.getView().byId("overviewPanel").invalidate();}},onEntitlementPanelExpand:function(E){this._toggleEntitlements(E.getParameter("expand"));},onOverviewPanelExpand:function(E){this._toggleOverview(E.getParameter("expand"));},_fillCalendarData:function(o){var C=this.getView().byId("calendar");var g=o.results;if(g){for(var i=0;i<g.length;i++){var l=g[i];var h=new c({startDate:l.StartDate,endDate:l.EndDate,type:f.statusCodeFormatter(l.StatusID),tooltip:l.StatusTxt,customData:{key:"path",value:this.getModel().createKey("/LeaveRequestSet",l).substr(1)}});C.addSpecialDate(h);}}},_toggleCalendarModel:function(S){this.getModel("local").setProperty("/showCalendar",S);this.getModel("local").setProperty("/viewSelection",S?"calendar":"list");this.oStorage.put(this.CALENDARPERSKEY,S);},_onRouteMatched:function(){this.oErrorHandler.setShowErrors("immediately");this.oErrorHandler.clearErrors();if(this._refresh){this._refresh=false;this._refreshAbsences();this._refreshEntitlements();}},_initOverviewModelBinding:function(E){this._readLeaveRequestWithDefaultStartDate(E);this._readEntitlements(E);},_readEntitlements:function(E){this.getModel("local").setProperty("/entitlementStartDate",new Date());this._oEntitlementColumListItemTemplate=this._oEntitlementColumListItemTemplate?this._oEntitlementColumListItemTemplate.clone():this.getView().byId("entitlementColumnListItem");this.getView().byId("entitlementTable").bindItems({path:"/TimeAccountSet",parameters:{operationMode:"Server"},template:this._oEntitlementColumListItemTemplate,filters:this._getActiveBaseFiltersForTimeAccount(new Date(),E)});},_readLeaveRequestWithDefaultStartDate:function(g){var h=[];h.push(new F("EmployeeID",a.EQ,g));this.oODataModel.read("/ConfigurationSet",{success:function(r){var i=r.results[0].DefaultFilterDate;this._bindLeaveRequestList(i,g);this.getModel("local").setProperty("/leaveRequestStartDate",i);}.bind(this),error:function(){var i=new Date(Date.UTC(new Date().getFullYear(),null,1));this._bindLeaveRequestList(i,g);this.getModel("local").setProperty("/leaveRequestStartDate",i);}.bind(this),filters:h});},_bindLeaveRequestList:function(g,h){var l=this.getModel("local"),t=this.getView().byId("leaveRequestTable");this._oLeaveRequestColumListItemTemplate=this._oLeaveRequestColumListItemTemplate?this._oLeaveRequestColumListItemTemplate.clone():this.getView().byId("leaveRequestColumnListItem");l.setProperty("/calendarBusy",true);t.bindItems({path:"/LeaveRequestSet",parameters:{operationMode:"Server"},template:this._oLeaveRequestColumListItemTemplate,filters:this._getActiveBaseFiltersForLeave(g,h),events:{dataReceived:function(E){var i=E.getParameter("data");if(i&&i.results){this._fillCalendarData(i);}l.setProperty("/calendarBusy",false);}.bind(this)}});},_getActiveBaseFiltersForTimeAccount:function(g,h){var i=[];i.push(new F("FilterStartDate",a.GE,g));i.push(new F("EmployeeID",a.EQ,h));return i;},_getActiveBaseFiltersForLeave:function(g,h){var i=[];i.push(new F("StartDate",a.GE,g));i.push(new F("EmployeeID",a.EQ,h));return i;},_refreshAbsences:function(){var l=this.getView().byId("leaveRequestTable").getBinding("items");l.refresh();},_refreshEntitlements:function(){var E=this.getView().byId("entitlementTable").getBinding("items");E.refresh();},_deleteRequest:function(i){var g=i.getBindingContext().getPath();this.getView().getModel().remove(g,{success:function(){this._refreshEntitlements();}.bind(this),error:function(E){jQuery.sap.log.error("An error occurred while removing LeaveRequest",E);}});},_toggleEntitlements:function(E){var l=this.getModel("local");this.oStorage.put(this.ENTITLEMENTSPERSKEY,E);l.setProperty("/entitlementsExpanded",E);},_toggleOverview:function(E){var l=this.getModel("local");this.oStorage.put(this.OVERVIEWPERSKEY,E);l.setProperty("/overviewExpanded",E);}});});
