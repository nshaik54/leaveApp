/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["hcm/fab/myleaverequest/utils/utils","hcm/fab/myleaverequest/utils/formatters","hcm/fab/myleaverequest/controller/BaseController","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat","sap/m/Label","sap/m/Text","sap/m/LabelDesign","sap/m/MessageBox","sap/m/MessagePopover","sap/m/MessagePopoverItem"],function(u,f,B,H,J,D,L,T,a,M,b,c){"use strict";return B.extend("hcm.fab.myleaverequest.controller.Display",{_oMessagePopover:null,formatter:f,onInit:function(){this.oErrorHandler=this.getOwnerComponent().getErrorHandler();this._oNotesModel=new J({NoteCollection:[]});this.setModel(this._oNotesModel,"noteModel");this.getRouter().getRoute("display").attachPatternMatched(this._onDisplayMatched,this);this._oLocalModel=this.getOwnerComponent().getModel("local");this._oLocalModel.setProperty("/notdataloading",false);this._oLocalModel.setProperty("/busy",true);this._oLocalModel.setProperty("/display-editEnabled",false);this._oLocalModel.setProperty("/display-withdrawEnabled",false);this.getOwnerComponent().getAssignmentId().then(function(e){this._oLocalModel.setProperty("/display-employeeId",e);}.bind(this));},onExit:function(){this.oErrorHandler.clearErrors();},onEditRequest:function(e){u.navTo.call(this,"edit",{leavePath:e.getSource().getBindingContext().getPath().substr(1)});},onDeleteRequest:function(e){var C=this.getOwnerComponent(),s=e.getSource().getBindingContext().getPath();M.confirm(this.getResourceBundle().getText("confirmDeleteMessage"),{styleClass:C.getContentDensityClass(),initialFocus:M.Action.CANCEL,onClose:function(A){if(A===M.Action.OK){this._deleteRequest(s);}}.bind(this)});},onHandlePopover:function(e){var m=e.getSource(),v=this.getView();if(!this._oMessagePopover){this._oMessagePopover=new b({items:{path:"message>/",template:new c({description:"{message>description}",type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}"})}});jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),v,this._oMessagePopover);v.addDependent(this._oMessagePopover);}this._oMessagePopover.toggle(m);},onNavBack:function(){this.oErrorHandler.clearErrors();var p=H.getInstance().getPreviousHash(),C=sap.ushell.Container.getService("CrossApplicationNavigation");if(p!==undefined||!C.isInitialNavigation()){history.go(-1);}else{C.toExternal({target:{shellHash:"#"}});}},_onDisplayMatched:function(e){this.oErrorHandler.clearErrors();var p=e.getParameter("arguments");this.getModel().metadataLoaded().then(function(){var o=p.leavePath;this._bindView("/"+o);}.bind(this));},_bindView:function(l){var o=this._oLocalModel;o.setProperty("/notdataloading",true);if(!this.getView().getModel().getProperty(l)){u.navTo.call(this,"overview",true);return;}var C=new sap.ui.model.Context(this.getView().getModel(),l);this.getView().setBindingContext(C);var d=C.getProperty(l);var n=d.Notes,N=this.formatter.formatNotes(n);this._oNotesModel.setProperty("/NoteCollection",N);var A=Array.apply(null,{length:5}).map(function(U,i){return d["Attachment"+(i+1)];}).filter(function(e){return e.FileName!=="";});o.setProperty("/attachments",A);o.setProperty("/notdataloading",true);o.setProperty("/busy",false);this._setButtonStates();},_deleteRequest:function(s){this._oLocalModel.setProperty("/busy",true);this.getView().getModel().remove(s,{success:function(){this._oLocalModel.setProperty("/busy",false);M.information(this.getResourceBundle().getText("deletedSuccessfully"),{title:this.getResourceBundle().getText("deleteLeaveRequest"),onClose:function(){sap.ui.getCore().getEventBus().publish("hcm.fab.myleaverequest","invalidateoverview","refresh");u.navTo.call(this,"overview");}.bind(this)});}.bind(this),error:function(e){}});},_initModel:function(e){var l=this.getView().getModel("local");l.setProperty("/display-editEnabled",false);l.setProperty("/display-withdrawEnabled",false);l.setProperty("/display-employeeId",e);},_setButtonStates:function(){var l=this.getView().getModel("local");var C=this.getView().getBindingContext();var e=false;var w=false;var E,d;E=C.getProperty("IsModifiable");d=C.getProperty("IsDeletable");e=E;w=d;l.setProperty("/display-editEnabled",e);l.setProperty("/display-withdrawEnabled",w);},_attachmentDateTimeFormatter:function(){var d=D.getDateTimeInstance();return d.format(new Date());},_attachmentUrlFormatter:function(A,F){var m=this.getView().getModel();var C=this.getView().getBindingContext();var e=C.getProperty("EmployeeID");var r=C.getProperty("RequestID");return m.sServiceUrl+["/FileAttachmentSet(EmployeeID='"+e+"'","LeaveRequestId='"+r+"'","ArchivDocId='"+A+"'","FileName='"+F+"')/$value"].join(",");}});});
