/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/message/Message","sap/ui/core/MessageType"],function(U,J,M,a,b){"use strict";function E(r){var c,o={sMessage:r,sDetails:null,aInnerErrors:[]};try{c=JSON.parse(r);if(c&&c.error){if(c.error.message&&c.error.message.value){o.sMessage=c.error.message.value;}if(c.error.code){o.sDetails=c.error.code;}if(c.error.innererror&&c.error.innererror.errordetails){o.aInnerErrors=c.error.innererror.errordetails;}}}catch(e){try{var x=jQuery.parseXML(r);}catch(f){jQuery.sap.log.error(f);}if(x){o.sMessage=x.getElementsByTagName("message")[0].childNodes[0].nodeValue||x.documentElement;o.sDetails=x.getElementsByTagName("code")[0].childNodes[0].nodeValue;o.aInnerErrors=x.getElementsByTagName("errordetail");}else{o.sMessage=r;}}return o;}function p(e){var P=null,r=null;P=e.getParameters?e.getParameters():null;r=P?(P.response||P):e;var c=r.responseText||r.body||(r.response&&r.response.body)||"";return E(c);}function g(s){switch(s){case"error":return b.Error;case"warning":return b.Warning;case"info":return b.Information;default:return b.Error;}}return U.extend("hcm.fab.myleaverequest.controller.ErrorHandler",{constructor:function(c,m,o){this._aErrors=[];this._showErrors="immediately";this._oMessageManager=o;this._oResourceBundle=c.getModel("i18n").getResourceBundle();this._oComponent=c;this._oModel=c.getModel();this._bMessageOpen=false;this._sErrorText=this._oResourceBundle.getText("errorTitle");this._oModel.attachMetadataFailed(function(e){var P=e.getParameters();this._showMetadataError(P.response);},this);this._oModel.attachRequestFailed(function(e){var d=p(e);if(this._showErrors==="immediately"){this._showServiceError(d.sMessage,d.sDetails);}else{jQuery.sap.log.error("OData response error: "+d.sMessage,d.sDetails);this._aErrors.push(d.sMessage);}o.removeAllMessages();d.aInnerErrors.forEach(function(i){if(i.message){o.addMessages(new a({message:i.message,description:i.code,additionalText:i.code,type:g(i.severity),processor:m}));}else{o.addMessages(new a({message:i.getElementsByTagName("message").childNodes[0].nodeValue,description:i.getElementsByTagName("code").childNodes[0].nodeValue,additionalText:i.getElementsByTagName("code").childNodes[0].nodeValue,type:g(i.getElementsByTagName("severity").childNodes[0].nodeValue),processor:m}));}});},this);},_showMetadataError:function(d){M.error(this._sErrorText,{id:"metadataErrorMessageBox",details:d,styleClass:this._oComponent.getContentDensityClass(),actions:[M.Action.RETRY,M.Action.CLOSE],onClose:function(A){if(A===M.Action.RETRY){this._oModel.refreshMetadata();}}.bind(this)});},_showServiceError:function(e,s,t){if(this._bMessageOpen){return;}this._bMessageOpen=true;M.error(e,{id:"serviceErrorMessageBox",title:t?t:this._sErrorText,details:s,styleClass:this._oComponent.getContentDensityClass(),actions:[M.Action.CLOSE],onClose:function(){this._bMessageOpen=false;}.bind(this)});},clearErrors:function(){this._oMessageManager.removeAllMessages();},setShowErrors:function(o){this._showErrors=o;},pushError:function(m){if(m){this._aErrors.push(m);}},hasPendingErrors:function(){return this._aErrors.length>0;},displayErrorPopup:function(){if(this._aErrors.length===0){return false;}var e=this._aErrors.join("\n");this._showServiceError(e);this._aErrors=[];return true;}});});
