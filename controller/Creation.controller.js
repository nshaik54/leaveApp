/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["hcm/fab/myleaverequest/utils/formatters","hcm/fab/myleaverequest/utils/utils","hcm/fab/myleaverequest/controller/BaseController","sap/ui/Device","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/base/Event","sap/m/Title","sap/m/Label","sap/m/Input","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/m/MessageToast","sap/m/MessageBox","sap/m/UploadCollectionParameter","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat","sap/ui/core/format/NumberFormat","hcm/fab/lib/common/controls/TeamCalendarControl","sap/m/Dialog","sap/m/Button","sap/m/StandardListItem"],function(f,u,B,D,H,F,E,T,L,I,M,a,b,c,U,J,d,N,e,g,h,S){"use strict";var k=5;var l=5;var O={"CompCode":{keyField:"CompanyCodeID",titleField:"CompanyCodeID",descriptionField:"CompanyCodeText",searchFields:"CompanyCodeID,CompanyCodeText"},"DescIllness":{keyField:"IllnessCode",titleField:"IllnessCode",descriptionField:"IllnessDescTxt",searchFields:"IllnessCode,IllnessDescTxt"},"CostCenter":{keyField:"CostCenterID",titleField:"CostCenterID",descriptionField:"CostCenterText",searchFields:"CostCenterID,CostCenterText"},"OtCompType":{keyField:"OverTimeCompID",titleField:"OverTimeCompID",descriptionField:"OverTimeCompText",searchFields:"OverTimeCompID,OverTimeCompText"},"TaxArea":{keyField:"WorkTaxAreaID",titleField:"WorkTaxAreaID",descriptionField:"WorkTaxAreaDesciption",searchFields:"WorkTaxAreaDesciption"},"ObjectType":{keyField:"ObjtypeID",titleField:"ObjtypeID",descriptionField:"ObjTypetext",searchFields:"ObjtypeID,ObjTypetext"},"WageType":{keyField:"WageTypeID",titleField:"WageTypeID",descriptionField:"WageTypeText",searchFields:"WageTypeID,WageTypeText"},"OrderID":{keyField:"OrderNumID",titleField:"OrderNumID",descriptionField:"OrderNumText",searchFields:"OrderNumID,OrderNumText"}};function m(o){var C=o.getParameter("element");var s=o.getParameter("message");if(C&&C.setValueStateText&&s){C.setValueStateText(s);}if(C&&C.setValueState){C.setValueState("Error");}}function n(o){var C=o.getParameter("element");if(C&&C.setValueState){C.setValueState("None");}}return B.extend("hcm.fab.myleaverequest.controller.Creation",{oLocalModel:null,iLogCounter:0,sCEEmployeeId:undefined,formatter:f,_messagesPopover:null,_notesBuffer:null,_previousAttachmentCollection:[],_previousInputHours:null,_previousStartTime:null,_previousEndTime:null,_multidayChanged:0,_editMode:false,_oMessagePopover:null,onInit:function(){var o=this.getOwnerComponent();this._oAdditionalFieldsControls={};this._absenceTypeReceivedDeferred=u.createDeferred();this._lastBalanceTimeUnitName=this.getResourceBundle().getText("daysTxt");this._maxAttachmentsText=this.getResourceBundle().getText("txtMaxAttachmentsReached");var r=o.getRouter();r.getRoute("creation").attachPatternMatched(this._onCreateRouteMatched,this);r.getRoute("creationWithParams").attachPatternMatched(this._onCreateRouteMatched,this);r.getRoute("edit").attachPatternMatched(this._onEditRouteMatched,this);this._oNotesModel=new J({NoteCollection:[]});this.setModel(this._oNotesModel,"noteModel");this.oODataModel=o.getModel();this.oLocalModel=o.getModel("local");this.oLocalModel.setProperty("/create-busy",true);this.oErrorHandler=o.getErrorHandler();this.initModel(this.oLocalModel);sap.ui.getCore().attachParseError(m);sap.ui.getCore().attachValidationSuccess(n);this.getView().byId("overlapCalendarInfoStrip").addStyleClass(D.system.phone?"sapUiTinyMargin":"");this.getView().byId("usedWorkingTimeText").addStyleClass(D.system.phone?"sapUiTinyMarginEnd":"sapUiTinyMarginBeginEnd");this.getView().byId("quotaText").addStyleClass(D.system.phone?"sapUiTinyMarginEnd":"sapUiTinyMarginBeginEnd");},initModel:function(o){this.setModelProperties(o,{"create-uploadPercentage":0,"create-multiOrSingleDayRadioGroupIndex":0,"create-BalanceAvailableQuantity":undefined,"create-TimeUnitName":undefined,"create-attachments":[],"create-attachmentsVisible":false,"create-attachmentsMandatory":false,"create-notes":"","create-showDatePicker":false,"create-showRange":true,"create-MultipleApprovers":[],"create-addDelApprovers":false,"create-approverLevel":0,"create-usedWorkingTime":this.getResourceBundle().getText("durationCalculationInitial"),"create-usedWorkingTimeUnit":undefined,"create-AdditionalFields":[],"create-MultipleApproverFlag":false,"create-readOnlyApprover":false,"create-showTimePicker":false,"create-showInputHours":false,"create-timePickerFilled":false,"create-inputHoursFilled":false,"create-viewTitle":null,"create-busy":false,"create-isApproverVisible":false,"create-isNoteVisible":false,"create-isQuotaCalculated":false,"create-singleAttachmentStripVisible":false,"create-maxAttachmentStripVisible":false,"create-duplicateAttachmentStripVisible":false,"calendar":{overlapNumber:0,assignmentId:this.sCEEmployeeId}},undefined,false);},onAbsenceTypeReceived:function(o){var i;i=o.getParameter("data").results;this._absenceTypeReceivedDeferred.resolve(i);},onNumberChange:function(o){var i=o.getSource(),s=i.getValue();if(s===""){i.setValue("0");}},onExit:function(){this._cleanupUnsubmittedViewChanges(this._editMode);this._destroyAdditionalFields();this.oErrorHandler.clearErrors();if(this._oDialog){this._oDialog.destroy();}if(this._oSearchHelperDialog){this._oSearchHelperDialog.destroy();}if(this._oOverlapCalendar){this._oOverlapCalendar.destroy();}if(this._overlapDialog){this._overlapDialog.destroy();}},onSendRequest:function(){var t=this,v=this.getViewModel(),o={};this.oErrorHandler.setShowErrors("manual");t.getView().unbindElement();var p=this.getView().getBindingContext().getPath();var s=function(P,V){var q=v.getProperty(P);if(V===q){return;}if(V&&V.equals&&V.equals(q)){return;}o[P]=q;v.setProperty(P,V);};this._copyAdditionalFieldsIntoModel(this.oLocalModel.getProperty("/create-AdditionalFields"),v,p);this._copyMultipleApproversIntoModel(v,p,this.oLocalModel.getProperty("/create-MultipleApprovers"));var i=this.oLocalModel.getProperty("/create-notes");if(i){s(p+"/Notes",i);}else{s(p+"/Notes",this._notesBuffer);}if(this._getNumberOfAttachments()>l){this.oErrorHandler.pushError(this._maxAttachmentsText);this.oErrorHandler.displayErrorPopup();this.oErrorHandler.setShowErrors("immediately");return;}if(this._editMode){this._updateLeaveRequestWithDeletedAttachments(v,p);}if((this.oLocalModel.getProperty("/create-multiOrSingleDayRadioGroupIndex")===null)||(this.oLocalModel.getProperty("/create-multiOrSingleDayRadioGroupIndex")===0)){v.setProperty(p+"/PlannedWorkingHours","0.0");v.setProperty(p+"/StartTime","000000");v.setProperty(p+"/EndTime","000000");}var j=function(q){this.oLocalModel.setProperty("/create-busy",false);this.oLocalModel.setProperty("/create-uploadPercentage",0);Object.keys(o).forEach(function(r){var w=o[r];v.setProperty(r,w);});this.oErrorHandler.pushError(q);this.oErrorHandler.displayErrorPopup();this.oErrorHandler.setShowErrors("immediately");};if(this._editMode){if(v.hasPendingChanges()){this.oLocalModel.setProperty("/create-busy",true);this.submitLeaveRequest({viewModel:v,leavePath:p}).then(this._uploadAttachments.bind(this)).then(this.showSuccessStatusMessage.bind(this)).then(function(){t.oErrorHandler.setShowErrors("immediately");}).catch(j.bind(this));}}else{this.oLocalModel.setProperty("/create-busy",true);this.submitLeaveRequest({viewModel:v,leavePath:p}).then(this._uploadAttachments.bind(this)).then(this.showSuccessStatusMessage.bind(this)).then(function(){t.oErrorHandler.setShowErrors("immediately");}).catch(j.bind(this));}},onCancel:function(){this._confirmCancel();},getViewModel:function(s){return this.getView().getModel(s);},submitLeaveRequest:function(p){return new Promise(function(r,R){var C,v=p.viewModel,s;C=0;var j=function(o){var q=o.getParameters();var t=o.getParameters().requests;var w;if(q.success){if(t){for(var i=0;i<t.length;i++){w=o.getParameters().requests[i];if(w.method==="POST"||w.method==="MERGE"||w.method==="PUT"){if(!w.success){R();return false;}else{C++;}}}}if(C>0){r({viewModel:v,leavePath:s});}}v.detachBatchRequestCompleted(j);};v.attachBatchRequestCompleted(j);v.submitChanges();});},updateLeaveRequestWithUploadedAttachments:function(p){var t=this;return new Promise(function(r,R){var o=0;if(p.uploadedFiles){o=p.uploadedFiles;}if(o.length>0){Array.apply(null,{length:l}).forEach(function(x,y){var z=o[y]||null;});}var q=0;var s=p.viewModel.getProperty(p.leavePath);Array.apply(null,{length:l}).map(function(x,y){return s["Attachment"+(y+1)];}).filter(function(x){if(x.FileName!==""){q++;}return x.FileName!=="";});var v=0;var w=t.getView().byId("AttachmentCollection");var A=w.getItems();for(var i=0;i<=(q-1);i++){for(var j=0;j<=(A.length-1);j++){if(A[j].getProperty("fileName")===s["Attachment"+(i+1)].FileName){v++;}}if(v===0){p.viewModel.setProperty(p.leavePath+"/Attachment"+(i+1)+"/AttachmentStatus","D");}v=0;}for(var i=0;i<=(o.length-1);i++){p.viewModel.setProperty(p.leavePath+"/Attachment"+(i+1+q)+"/FileName",o[i].FileName);}setTimeout(function(){r({viewModel:p.viewModel,leavePath:p.leavePath,uploadedFiles:p.uploadedFiles});},0);});},_updateLeaveRequestWithDeletedAttachments:function(v,o){var p=0;var q=v.getProperty(o);Array.apply(null,{length:l}).map(function(y,z){return q["Attachment"+(z+1)];}).filter(function(y){if(y.FileName!==""){p++;}return y.FileName!=="";});var r=0;var s=this.getView().byId("AttachmentCollection");var A=s.getItems();for(var i=0;i<=(p-1);i++){for(var j=0;j<=(A.length-1);j++){if(A[j].getProperty("fileName")===q["Attachment"+(i+1)].FileName){r++;}}if(r===0){v.setProperty(o+"/Attachment"+(i+1)+"/AttachmentStatus","D");}r=0;}var t=s.getItems();var w=t[0];var x=s._aFileUploadersForPendingUpload;if(x.length>=1){if(w){if(w._status!=="display"){v.setProperty(o+"/Attachment"+(p+1)+"/FileName",x[0].getProperty("value"));}}}},createLeaveRequestCollection:function(){return this.oODataModel.createEntry("/LeaveRequestSet",{properties:{StartDate:null,EndDate:null}});},onAdditionalFieldChanged:function(A){this._additionalFieldsToSubmit[A]=true;},onAbsenceTypeChange:function(o){var A,i=this.getSelectedAbsenceTypeControl();var j=this.getView().getBindingContext().getPath();if(i){A=i.getBindingContext();this.updateViewModel(A.getObject(),{});var p=A.getProperty("toAdditionalFieldsDefinition")||[];var q={definition:p,values:this._getAdditionalFieldValues(p,this._getCurrentAdditionalFieldValues())};this._destroyAdditionalFields();var r=this._getApprovers(A.getProperty("MultipleApproverFlag"),{Name:"",Pernr:""},A.getProperty("toApprover"));this._updateLocalModel(r,q,A.getObject(),{StartDate:this.getViewModel().getProperty(j+"/StartDate"),EndDate:this.getViewModel().getProperty(j+"/EndDate")});this._fillAdditionalFields(this.oLocalModel,A.getProperty("AbsenceTypeCode"),this._getAdditionalFieldsContainer());var s=false;this._updateCalcLeaveDays(s);}},onSingleMultiDayRadioSelected:function(o){var C,i,s,v,j,r;r=o.getSource();j=r.getSelectedIndex()===0;v=this.getViewModel();s=this.getView().getBindingContext().getPath();i=v.getProperty(s+"/StartDate");C=v.getProperty(s+"/EndDate");if(i){if(j){if(!C){v.setProperty(s+"/EndDate",i);}}else{if(C){v.setProperty(s+"/EndDate",i);}}this._updateCalcLeaveDays(false);}},onDateRangeChanged:function(o){var v=o.getParameter("valid"),i=o.getSource(),s=u.dateToUTC(o.getParameter("from")),j=this.getView().getBindingContext().getPath("StartDate"),p=u.dateToUTC(o.getParameter("to")),q=this.getView().getBindingContext().getPath("EndDate");if(v){i.setValueState(sap.ui.core.ValueState.None);this.getViewModel().setProperty(j,s);this.getViewModel().setProperty(q,p);this._updateCalcLeaveDays(false);}else{i.setValueState(sap.ui.core.ValueState.Error);}},onInputHoursChange:function(o){if(o.getParameter("value")){this.oLocalModel.setProperty("/create-inputHoursFilled",true);var s=this.getView().getBindingContext().getPath("StartTime");this.getViewModel().setProperty(s,"");var i=this.getView().getBindingContext().getPath("EndTime");this.getViewModel().setProperty(i,"");var p=this.getView().getBindingContext().getPath("PlannedWorkingHours");this.getViewModel().setProperty(p,o.getParameter("value"));this._updateCalcLeaveDays(true);}else{this.oLocalModel.setProperty("/create-inputHoursFilled",false);}},onDatePickChanged:function(o){var i=d.getDateInstance().parse(o.getParameter("newValue"),true);var s=this.getView().getBindingContext().getPath("EndDate");this.getViewModel().setProperty(s,i);this._updateCalcLeaveDays(false);},onDateChange:function(o){var v=o.getParameter("valid"),i=o.getSource();if(v){i.setValueState(sap.ui.core.ValueState.None);this._updateCalcLeaveDays(false);}else{i.setValueState(sap.ui.core.ValueState.Error);}},onTimeChange:function(o){if(o.getParameter("newValue")){this.oLocalModel.setProperty("/create-timePickerFilled",true);}else{this.oLocalModel.setProperty("/create-timePickerFilled",false);}this._updateCalcLeaveDays(false);},onApproverValueHelp:function(o){if(!this._oDialog){var i={handleSearch:this.handleApproverDialogSearch.bind(this),handleClose:this.handleApproverDialogClose.bind(this)};this._oDialog=sap.ui.xmlfragment("hcm.fab.myleaverequest.view.fragments.ApproverDialog",i);jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),this.getView(),this._oDialog);this.getView().addDependent(this._oDialog);}this._oDialog.data("initiator",o.getSource());this._oDialog.open();},onRemoveApproverClicked:function(o){var A,i;i=this.getOwnerComponent().getModel("local");A=i.getProperty("/create-MultipleApprovers").slice(0);A.pop();i.setProperty("/create-MultipleApprovers",A);},notesLiveChange:function(o){var t=o.getParameter("newValue");if(t.length<2){return;}if(t.indexOf("::")>-1){var C=o.getSource().getFocusDomRef().selectionStart;o.getSource().setValue(t.replace(/(:)+/g,"$1"));o.getSource().getFocusDomRef().setSelectionRange(C,C-1);}},onAttachmentChange:function(o){var i=false;var j=this.getView().byId("AttachmentCollection");var A=j.getItems();var p=A[0];var s=o.getParameter("files")[0].name;this.oLocalModel.setProperty("/create-singleAttachmentStripVisible",false);this.oLocalModel.setProperty("/create-maxAttachmentStripVisible",false);this.oLocalModel.setProperty("/create-duplicateAttachmentStripVisible",false);A.forEach(function(r){if(r.getProperty("fileName")===s){j.removeItem(r);this.oLocalModel.setProperty("/create-duplicateAttachmentStripVisible",true);i=true;return;}}.bind(this));if((A.length>=l)&&!i){this.oLocalModel.setProperty("/create-maxAttachmentStripVisible",true);j.removeItem(p);i=true;}if(!i){var q=j._aFileUploadersForPendingUpload;if(q.length>=1){if(p){if(p._status!=="display"){this.oLocalModel.setProperty("/create-singleAttachmentStripVisible",true);j.removeItem(p);}}}}},onBeforeUploadStarts:function(o){var i=o.getParameters();var C=new U({name:"slug",value:o.getParameter("fileName")});i.addHeaderParameter(C);var j=new U({name:"x-csrf-token",value:this.getView().getModel().getSecurityToken()});i.addHeaderParameter(j);},onHandlePopover:function(o){var i=o.getSource(),v=this.getView();if(!this._oMessagePopover){this._oMessagePopover=new M({items:{path:"message>/",template:new a({description:"{message>description}",type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}"})}});jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),v,this._oMessagePopover);v.addDependent(this._oMessagePopover);}this._oMessagePopover.toggle(i);},handleApproverDialogSearch:function(o){var s=o.getParameter("value"),i=new S({title:"{ApproverEmployeeName}",description:"{ApproverEmployeeID}"});o.getSource().bindAggregation("items",{path:"/SearchApproverSet",parameters:{custom:s?{search:encodeURIComponent(s)}:{},countMode:sap.ui.model.odata.CountMode.Inline},template:i});},handleApproverDialogClose:function(o){var A,i,j,p,s,q,r,C;C=o.getParameter("selectedContexts");if(C.length){r=C[0].sPath;q=this.getViewModel().getProperty(r+"/ApproverEmployeeID");s=this.getViewModel().getProperty(r+"/ApproverEmployeeName");p=o.getSource().data("initiator");j=this.oLocalModel.getProperty("/create-MultipleApprovers");i=f.getSuperControlIndex(p);A=j.slice(0);A[i]={Name:s,Pernr:q,Seqnr:"0"+i+1,DefaultFlag:""};this.oLocalModel.setProperty("/create-MultipleApprovers",A);}},handleSearchHelperDialogSearch:function(o){var i,s,j;j=o.getSource().data("initiator");s=o.getParameter("value");var p=new F({filters:j.data("helperCollectionFilterFields").split(",").map(function(q){return new F(q,sap.ui.model.FilterOperator.Contains,s);}),and:false});i=o.getSource().getBinding("items");i.filter([p]);},handleSearchHelperDialogClose:function(o){var s,i,j,p=(o.getParameter("selectedContexts")||[])[0];if(!p){return;}j=o.getSource().data("initiator");i=j.data("helperFieldToValueAfterSelection");s=p.getProperty(p.getPath()+"/"+i);var C=j.getBindingContext("local").getPath();this.oLocalModel.setProperty(C+"/value",s);},onSearchHelperRequest:function(o){var t=this;var s=o.getSource();var i=s.getValue();if(!this._oSearchHelperDialog){var j={handleSearch:this.handleSearchHelperDialogSearch.bind(this),handleClose:this.handleSearchHelperDialogClose.bind(this)};this._oSearchHelperDialog=sap.ui.xmlfragment("hcm.fab.myleaverequest.view.fragments.SearchHelperDialog",j);}this.getSearchHelperDialogModel(s.data("helperTitleText"),s.data("helperNoDataFoundText"),s.data("helperCollection"),s.data("helperCollectionTitleField"),s.data("helperCollectionDescriptionField")).then(function(p){t._oSearchHelperDialog.setModel(p);t._oSearchHelperDialog.data("initiator",s);var q=new E("initSearch",t._oSearchHelperDialog,{value:i});t.handleSearchHelperDialogSearch(q);t._oSearchHelperDialog.open(i);},function(p){jQuery.sap.log.error("Error occurred while loading value help",p);});},onNavBack:function(){this._confirmCancel();},onAddApproverClicked:function(o){var A,i,j=this.getModel("local");i=j.getProperty("/create-MultipleApprovers");A=i.slice(0);A.push({});j.setProperty("/create-MultipleApprovers",A);},showSuccessStatusMessage:function(p){var t=this;var s=this.getModel("local").getProperty("/create-viewTitle");var i=this.getResourceBundle().getText("createdSuccessfully");this.oLocalModel.setProperty("/create-busy",false);c.show(i,{icon:c.Icon.INFORMATION,title:s,actions:[c.Action.OK],onClose:function(){sap.ui.getCore().getEventBus().publish("hcm.fab.myleaverequest","invalidateoverview","refresh");u.navTo.call(t,"overview");}});return Promise.resolve(p);},getSelectedAbsenceTypeControl:function(){return this.getView().byId("absenceType").getSelectedItem();},getSearchHelperDialogModel:function(s,i,C,t,j){var o=this;return new Promise(function(r,R){o.getViewModel().read("/"+C,{success:function(p,q){if(!p.hasOwnProperty("results")){R("Cannot find 'results' member in the "+C+" collection");return;}var v={DialogTitle:s,NoDataText:i,Collection:[]};v.Collection=p.results.map(function(w){var x=jQuery.extend({},w,true);x.Title=w[t];x.Description=w[j];return x;});r(new J(v));},error:function(p){R(p);}});});},setModelProperties:function(o,p,P,i){if(typeof i==="undefined"){i=true;}var j=Object.keys(p);var q=j.length;j.forEach(function(s,r){var A=true;var t=(P||"")+"/"+s;if(r===q-1&&i){A=false;}o.setProperty(t,p[s],A);});},updateViewModel:function(A,r){var p=this.getView().getBindingContext().getPath();var o={"EmployeeID":A.EmployeeID,"AbsenceTypeName":A.AbsenceTypeName};var s=r.absenceType&&r.absenceType!=="default"?r.absenceType:A.AbsenceTypeCode;o.AbsenceTypeCode=s;var i=r.dateFrom?new Date(parseInt(r.dateFrom,10)):null;if(i){o.StartDate=i;}var j=r.dateTo?new Date(parseInt(r.dateTo,10)):null;if(j){o.EndDate=j;}var v=this.getViewModel();this.setModelProperties(v,o,p,false);},_navBack:function(){this.oErrorHandler.clearErrors();var p=H.getInstance().getPreviousHash(),C=sap.ushell.Container.getService("CrossApplicationNavigation");if(p!==undefined||!C.isInitialNavigation()){history.go(-1);}else{C.toExternal({target:{shellHash:"#"}});}},_confirmCancel:function(){var C=this.getOwnerComponent(),o=this.getViewModel();if(o.hasPendingChanges()){c.confirm(this.getResourceBundle().getText("cancelPopover"),{styleClass:C.getContentDensityClass(),initialFocus:c.Action.CANCEL,onClose:function(A){if(A===c.Action.OK){this._cleanupUnsubmittedViewChanges(this._editMode);this._navBack();}}.bind(this)});}else{this._navBack();}},_onCreateRouteMatched:function(o){var t=this,r;this.oErrorHandler.setShowErrors("immediately");this.oErrorHandler.clearErrors();this._editMode=false;this._notesBuffer="";this._destroyAdditionalFields();this._cleanupAttachmentCollection();this._cleanupUnsubmittedViewChanges(false);this.oLocalModel.setProperty("/create-viewTitle",this.getResourceBundle().getText("createViewTitle"));r=o.getParameter("arguments");var A=this.getOwnerComponent().getAssignmentId();Promise.all([this.oODataModel.metadataLoaded(),A]).then(function(p){if(this.sCEEmployeeId!==p[1]){this._absenceTypeReceivedDeferred=u.createDeferred();this.sCEEmployeeId=p[1];var i=[];i.push(new F("EmployeeID",sap.ui.model.FilterOperator.EQ,this.sCEEmployeeId));this._oSelectionItemTemplate=this.getView().byId("selectionTypeItem");this.oLocalModel.setProperty("/create-busy",true);var j=this.getView().byId("absenceType");j.bindItems({path:"/AbsenceTypeSet",template:this._oSelectionItemTemplate,filters:i,parameters:{expand:"toAdditionalFieldsDefinition,toApprover"},events:{dataReceived:this.onAbsenceTypeReceived.bind(this)}});}this._initOverlapCalendar();this._absenceTypeReceivedDeferred.promise.then(function(q){var s=q;var v,w;t.oLocalModel.setProperty("/create-busy",false);v=t.createLeaveRequestCollection();t.getView().setBindingContext(v);w=s[0].AbsenceTypeCode;if(r.absenceType&&r.absenceType&&r.absenceType!=="default"){w=r.absenceType;}var x=s.filter(function(Q){return Q.AbsenceTypeCode===w;})[0];t.updateViewModel(x,r);var y=t.getSelectedAbsenceTypeControl();var z=jQuery.extend(true,{},x);var C=y.getBindingContext();var G=C.getProperty("toAdditionalFieldsDefinition")||[];var K={definition:G,values:t._getAdditionalFieldValues(G,{})};var P=t._getApprovers(C.getProperty("IsMultiLevelApproval"),{Name:"",Pernr:""},C.getProperty("toApprover"));t._updateLocalModel(P,K,z,{StartDate:t.getViewModel().getProperty(v.getPath()+"/StartDate"),EndDate:t.getViewModel().getProperty(v.getPath()+"/EndDate")});t._fillAdditionalFields(t.oLocalModel,z.AbsenceTypeCode,t._getAdditionalFieldsContainer());t._updateCalcLeaveDays(false);t.oLocalModel.setProperty("/create-busy",false);});}.bind(this));},_onEditRouteMatched:function(o){var t=this,r=o.getParameter("arguments"),s="/"+r.leavePath;this._cleanUpAttachmentCollectionIfCreated();this.oErrorHandler.setShowErrors("immediately");this.oErrorHandler.clearErrors();this._destroyAdditionalFields();this._notesBuffer=this.getViewModel().getProperty(s+"/Notes");this.oLocalModel.setProperty("/create-viewTitle",this.getResourceBundle().getText("editViewTitle"));this._editMode=true;this._cleanupUnsubmittedViewChanges(true);var A=this.getOwnerComponent().getAssignmentId();Promise.all([this.oODataModel.metadataLoaded(),A]).then(function(p){if(this.sCEEmployeeId!==p[1]){this._absenceTypeReceivedDeferred=u.createDeferred();this.sCEEmployeeId=p[1];var i=[];i.push(new F("EmployeeID",sap.ui.model.FilterOperator.EQ,this.sCEEmployeeId));this._oSelectionItemTemplate=this.getView().byId("selectionTypeItem");var j=this.getView().byId("absenceType");j.bindItems({path:"/AbsenceTypeSet",template:this._oSelectionItemTemplate,filters:i,parameters:{expand:"toAdditionalFieldsDefinition,toApprover"}});j.getBinding("items").attachDataReceived(this.onAbsenceTypeReceived.bind(this));}this._initOverlapCalendar();var q=this.getViewModel().getProperty(s);if(q){this._absenceTypeReceivedDeferred.promise.then(function(){var v=new sap.ui.model.Context(t.getViewModel(),s);t.getView().unbindElement();t.getView().setBindingContext(v);var w=t.getSelectedAbsenceTypeControl();var x=q.Notes,y=t.formatter.formatNotes(x);t._oNotesModel.setProperty("/NoteCollection",y);var z=w.getBindingContext();var C=z.getObject();q.ApproverLevel=C.ApproverLevel;var G=z.getProperty("toAdditionalFieldsDefinition");var K={definition:G,values:t._getAdditionalFieldValues(G,q.AdditionalFields)};var P=t._getEditApprovers(z.getProperty("IsMultiLevelApproval"),{Name:v.getProperty("ApproverLvl1/Name"),Pernr:v.getProperty("ApproverLvl1/Pernr"),Seqnr:v.getProperty("ApproverLvl1/Seqnr"),DefaultFlag:v.getProperty("ApproverLvl1/DefaultFlag")},Array.apply(null,{length:k}).map(function(W,X){return v.getProperty("ApproverLvl"+(X+1));}).filter(function(W){return W&&!!(W.Name);}));t._updateLocalModel(P,K,z.getObject(),{StartDate:q.StartDate,EndDate:q.EndDate});t._fillAdditionalFields(t.oLocalModel,C.AbsenceTypeCode,t._getAdditionalFieldsContainer());var Q=0;var R=t.oODataModel.sServiceUrl;t.oLocalModel.setProperty("/create-attachments",Array.apply(null,{length:l}).map(function(W,X){return q["Attachment"+(X+1)];}).filter(function(W){Q++;if(W.FileName!==""){var X="/FileAttachmentSet(EmployeeID='"+q.EmployeeID+"',LeaveRequestId='"+q.RequestID+"',FileName='"+(q["Attachment"+(Q)].FileName)+"',ArchivDocId='"+(q["Attachment"+(Q)].ArchivDocId)+"')/$value";W.FileUrl=R+X;}return W.FileName!=="";}));var V=t.getView().byId("AttachmentCollection");t._previousAttachmentCollection=V.getItems();t._updateCalcLeaveDays(false);t.oLocalModel.setProperty("/create-busy",false);});}else{u.navTo.call(this,"overview",true);}}.bind(this));},_destroyAdditionalFields:function(){var t=this;Object.keys(this._oAdditionalFieldsControls).forEach(function(s){var C=t._oAdditionalFieldsControls[s];C.forEach(function(o,i){o.destroy();if(i>0){delete t._oAdditionalFieldsControls[s];}});});},_getAdditionalFieldsContainer:function(){return this.getView().byId("additionalFieldsSimpleForm");},_getAdditionalFieldFragmentName:function(A){if(A.Type_Kind==="T"){return"AdditionalFieldTimePicker";}if(A.Type_Kind==="D"){return"AdditionalFieldDatePicker";}if(f.isAdditionalFieldCheckbox(A.Type_Kind,A.Length)){return"AdditionalFieldCheckbox";}if(f.isAdditionalFieldInputDecimal(A.Type_Kind)){return null;}if(f.isAdditionalFieldInputInteger(A.Type_Kind)){return"AdditionalFieldInputInteger";}if(f.isAdditionalFieldInput(A.Type_Kind,A.Length)&&A.HasF4===true){return"AdditionalFieldSearchHelperInput";}return"AdditionalFieldInput";},_callCalcLeaveDaysFunctionImport:function(p){var t=this;return new Promise(function(r,R){t.oODataModel.callFunction("/CalculateLeaveSpan",{method:"GET",urlParameters:p,success:function(o){r(o);},error:function(o){R(o);}});});},_callAvailableQuotaFunctionImport:function(p){var t=this;return new Promise(function(r,R){t.oODataModel.callFunction("/CalculateQuotaAvailable",{method:"GET",urlParameters:p,success:function(o){r(o);},error:function(o){R(o);}});});},_cleanupAttachmentCollection:function(){var A=this.getView().byId("AttachmentCollection");if(A){A.removeAllItems();}},_cleanUpAttachmentCollectionIfCreated:function(){this._previousAttachmentCollection.forEach(function(o){o.destroy();});this._previousAttachmentCollection=[];var A=this.getView().byId("AttachmentCollection");var p=A._aFileUploadersForPendingUpload;p.forEach(function(o){o.destroy();});A._aFileUploadersForPendingUpload=[];},_cleanupUnsubmittedViewChanges:function(i){var C=this.getView().getBindingContext();if(!C){return;}var s=C.getPath();if(i){if(this.oODataModel.hasPendingChanges()){this.oODataModel.resetChanges([s]);this.getView().setBindingContext(null);}}else{if(C){this.oODataModel.deleteCreatedEntry(C);this.getView().setBindingContext(null);}}},_getAttachmentsUploadUrl:function(){return[this.getViewModel().sServiceUrl,this.getView().getBindingContext().getPath(),"/toAttachments"].join("");},_getNumberOfAttachments:function(){var o=this.byId("AttachmentCollection");var A=o.getItems();return A.length;},_updateUploadUrls:function(A,s){var t=this,i,o;var j=0;A.forEach(function(p){i=p.getFileUploader();if(!i){return;}o=t.getView().byId(i);o.setUploadUrl(s);t._previousAttachmentCollection[t._previousAttachmentCollection.length]=p;j++;});return j;},_updateCalcLeaveDays:function(i){var t=this;var s=null;var j=null;var o=null;var p=null;var v=this.getViewModel();var V=this.getView().getBindingContext();var q=d.getDateTimeInstance({pattern:"yyyyMMdd"});var C=V.getPath();var r=v.getProperty(C+"/StartDate");var R=v.getProperty(C+"/EndDate");if(!r||!f.isGroupEnabled(r,this.getSelectedAbsenceTypeControl().getBindingContext().getObject().AbsenceTypeCode)){return;}var w=this.getResourceBundle().getText("durationCalculation");this.oLocalModel.setProperty("/create-usedWorkingTime",w);this.oLocalModel.setProperty("/create-usedWorkingTimeUnit",null);var x=q.format(r);var y=q.format(R);if(t.oLocalModel.getProperty("/create-multiOrSingleDayRadioGroupIndex")===0){s="";j="";}else{s=v.getProperty(C+"/StartTime");if(!s){s="";}j=v.getProperty(C+"/EndTime");if(!j){j="";}}var z=v.getProperty(C+"/LeaveKey");if(!this._editMode){z="";}var A=v.getProperty(C+"/RequestID");if(!this._editMode){A="";}if(t.oLocalModel.getProperty("/create-multiOrSingleDayRadioGroupIndex")===0){o="0.0";}else{o=v.getProperty(C+"/PlannedWorkingHours");if(!o||o<=0){o="0.0";}var G=N.getFloatInstance({parseAsString:true});p=G.parse(o);if(i){v.setProperty(C+"/PlannedWorkingHours",p);}if(!p){p="";}}if(!p||p<=0||p>24){p="0.0";}var K=v.getProperty(C+"/StatusID");if(!K){K="";}this._callCalcLeaveDaysFunctionImport({AbsenceTypeCode:this.getSelectedAbsenceTypeControl().getBindingContext().getObject().AbsenceTypeCode,EmployeeID:this.getSelectedAbsenceTypeControl().getBindingContext().getObject().EmployeeID,InfoType:this.getSelectedAbsenceTypeControl().getBindingContext().getObject().InfoType,StartDate:x,EndDate:y,BeginTime:s,EndTime:j,RequestID:A,InputHours:p,StatusID:K,LeaveKey:z}).then(function(P){var Q,W;if(!P){t.oLocalModel.setProperty("/create-usedWorkingTime",null);t.oLocalModel.setProperty("/create-usedWorkingTimeUnit",null);return;}W=parseFloat(P.CalculateLeaveSpan.QuotaUsed);Q=t._lastBalanceTimeUnitName;if(P.CalculateLeaveSpan.TimeUnitText){Q=P.CalculateLeaveSpan.TimeUnitText;}t.oLocalModel.setProperty("/create-usedWorkingTime",W);t.oLocalModel.setProperty("/create-usedWorkingTimeUnit",Q);if(t.oLocalModel.getProperty("/create-multiOrSingleDayRadioGroupIndex")===1){if(i===true){if(t.byId("startTimePick").getVisible()){if(P.CalculateLeaveSpan.BeginTime){v.setProperty(C+"/StartTime",P.CalculateLeaveSpan.BeginTime);}else{v.setProperty(C+"/StartTime","");}}if(t.byId("endTimePick").getVisible()){if(P.CalculateLeaveSpan.EndTime){v.setProperty(C+"/EndTime",P.CalculateLeaveSpan.EndTime);}else{v.setProperty(C+"/EndTime","");}}}else{if(t.byId("hoursValue").getVisible()){if(P.CalculateLeaveSpan.AttabsHours){v.setProperty(C+"/PlannedWorkingHours",P.CalculateLeaveSpan.AttabsHours);}}}}},function(P){jQuery.sap.log.error("An error occurred while calling CalcLeaveDays function import",P);t.oLocalModel.setProperty("/create-usedWorkingTime",null);t.oLocalModel.setProperty("/create-usedWorkingTimeUnit",null);});},_updateAvailableQuota:function(){var t=this;var C=this.getResourceBundle().getText("availabilityCalculation");t.oLocalModel.setProperty("/create-BalanceAvailableQuantity",C);t.oLocalModel.setProperty("/create-TimeUnitName",null);return this._callAvailableQuotaFunctionImport({AbsenceTypeCode:this.getSelectedAbsenceTypeControl().getBindingContext().getObject().AbsenceTypeCode,EmployeeID:this.getSelectedAbsenceTypeControl().getBindingContext().getObject().EmployeeID,InfoType:this.getSelectedAbsenceTypeControl().getBindingContext().getObject().InfoType}).then(function(A){var s,i;if(!A){t.oLocalModel.setProperty("/create-BalanceAvailableQuantity",null);t.oLocalModel.setProperty("/create-TimeUnitName",null);return;}i=parseFloat(A.CalculateQuotaAvailable.BalanceRestPostedRequested);s=t._lastBalanceTimeUnitName;if(A.CalculateQuotaAvailable.TimeUnitText){s=A.CalculateQuotaAvailable.TimeUnitText;}t.oLocalModel.setProperty("/create-BalanceAvailableQuantity",i);t.oLocalModel.setProperty("/create-TimeUnitName",s);},function(o){jQuery.sap.log.error("An error occurred while calling CalcLeaveDays function import",o);t.oLocalModel.setProperty("/create-BalanceAvailableQuantity",null);t.oLocalModel.setProperty("/create-TimeUnitName",null);});},_copyMultipleApproversIntoModel:function(o,p,A){Array.apply(null,{length:k}).forEach(function(i,j){var q=A[j];if(!q){q={Name:"",Pernr:"00000000",Seqnr:"000",DefaultFlag:""};}o.setProperty(p+"/ApproverLvl"+(j+1)+"/Name",q.Name);o.setProperty(p+"/ApproverLvl"+(j+1)+"/Pernr",q.Pernr);o.setProperty(p+"/ApproverLvl"+(j+1)+"/Seqnr",q.Seqnr);o.setProperty(p+"/ApproverLvl"+(j+1)+"/DefaultFlag",q.DefaultFlag);});if(!this._editMode){o.setProperty(p+"/IsMultiLevelApproval",this.oLocalModel.getProperty("/create-MultipleApproverFlag"));}},_getApprovers:function(i,s,j){var v=this.getViewModel();if(!i){var o={Name:v.getProperty("/"+j+"/Name"),Pernr:v.getProperty("/"+j+"/Pernr"),Seqnr:v.getProperty("/"+j+"/Seqnr"),DefaultFlag:v.getProperty("/"+j+"/DefaultFlag")};return[o];}return j.map(function(p){return{Name:v.getProperty("/"+p+"/Name"),Pernr:v.getProperty("/"+p+"/Pernr"),Seqnr:v.getProperty("/"+j+"/Seqnr"),DefaultFlag:v.getProperty("/"+j+"/DefaultFlag")};});},_getEditApprovers:function(j,s,o){if(!j){return[s];}var p=[];for(var i=0;i<o.length;i++){p[i]={Name:o[i].Name,Pernr:o[i].Pernr,Seqnr:o[i].Seqnr,DefaultFlag:o[i].DefaultFlag};}return p;},_waitOnEmployeeId:function(r){if(!r){return this.getOwnerComponent().employeeIdPromise;}return new Promise(function(R,i){R(r);});},_getAdditionalFieldDefaultValue:function(s){var v="";switch(s){case"T":v=null;break;case"D":v=null;break;default:v="";}return v;},_getAdditionalFieldValues:function(A,v){var t=this;var o={};A.forEach(function(s){var i,j,p;p=t.getViewModel().getObject("/"+s);j=s.split("('")[1].replace("')","");if(v.hasOwnProperty(j)){i=v[j];}else{i=t._getAdditionalFieldDefaultValue(p.Type_Kind);}o[j]=i;});return o;},_getCurrentAdditionalFieldValues:function(){var C={};this.oLocalModel.getProperty("/create-AdditionalFields").forEach(function(o){C[o.Fieldname]=o.value;});return C;},_fillAdditionalFields:function(o,A,C){C.removeAllContent();o.getProperty("/create-AdditionalFields").forEach(function(i,j){var s=this._getAdditionalFieldFragmentName(i);if(!this._oAdditionalFieldsControls[i.Fieldname]){if(s){this._oAdditionalFieldsControls[i.Fieldname]=sap.ui.xmlfragment(this.getView().getId()+i.Fieldname,"hcm.fab.myleaverequest.view.fragments."+s,this);}else{this._addAdditionalFieldDecimal(this.getView(),C,o,j,this.onNumberChange,i,this._oAdditionalFieldsControls);}}this._oAdditionalFieldsControls[i.Fieldname].forEach(function(p){p.setBindingContext(o.createBindingContext("/create-AdditionalFields/"+j),"local");this.getView().addDependent(p);C.addContent(p);}.bind(this));}.bind(this));},_addAdditionalFieldDecimal:function(v,C,o,i,j,A,p){var s=v.getId()+A.Fieldname+"addFieldInputDecimal";var q=new L(s+"Label",{required:"{local>Required}",text:"{local>FieldLabel}"});q.setBindingContext(o.createBindingContext("/create-AdditionalFields/"+i),"local");v.addDependent(q);C.addContent(q);var r=new I(s,{type:"Text",change:j,textAlign:"Right",enabled:"{ formatter: 'hcm.fab.myleaverequest.utils.formatters.isGroupEnabled', parts: [ { path: 'StartDate' }, { path: 'AbsenceTypeCode' } ]}"});r.setBindingContext(o.createBindingContext("/create-AdditionalFields/"+i),"local");r.bindValue({path:"local>value",type:new sap.ui.model.odata.type.Decimal({parseAsString:true,decimals:parseInt(A.Decimals),maxIntegerDigits:(parseInt(A.Length)-parseInt(A.Decimals)),minFractionDigits:0,maxFractionDigits:parseInt(A.Decimals)},{precision:parseInt(A.Length),scale:parseInt(A.Decimals)})});v.addDependent(r);C.addContent(r);if(!p[A.Fieldname]){p[A.Fieldname]=[];p[A.Fieldname].push(q);p[A.Fieldname].push(r);}},_copyAdditionalFieldsIntoModel:function(A,o,s){A.forEach(function(i){var j=i.Fieldname;var v=i.value;if(typeof v==="boolean"&&i.Type_Kind==="C"){v=v?"X":"";}if(f.isAdditionalFieldInputInteger(i.Type_Kind)){v=v+"";}if(typeof v==="string"&&v===""&&i.Type_Kind==="P"){v=null;}o.setProperty(s+"/AdditionalFields/"+j,v);});},_updateLocalModel:function(A,o,i,j){var p,C,t;t=this;C=this.getResourceBundle().getText("availabilityCalculation");p=o.definition.map(function(s){var r,v,w;w=t.getViewModel().getObject("/"+s);v=s.split("('")[1].replace("')","");w.value=o.values[v];r=O[w.Fieldname];if(!r){r={};}w.additionalFieldKey=r.keyField;w.F4EntityTitleField=r.titleField;w.F4EntityDescriptionField=r.descriptionField;w.F4SearchFilter=r.searchFields;return w;});var q=0;if(!f.isMoreThanOneDayAllowed(i.IsAllowedDurationMultipleDay)||(f.isOneDayOrLessAllowed(i.IsAllowedDurationMultipleDay,i.IsAllowedDurationSingleDay)&&j&&j.StartDate&&j.EndDate&&j.StartDate.getTime()===j.EndDate.getTime()&&j.StartDate instanceof Date)){q=1;}this.setModelProperties(this.oLocalModel,{"create-multiOrSingleDayRadioGroupIndex":q,"create-attachmentsVisible":i.AttachmentEnabled,"create-attachmentsMandatory":i.AttachmentMandatory,"create-BalanceAvailableQuantity":C,"create-TimeUnitName":undefined,"create-AllowedDurationMultipleDayInd":i.IsAllowedDurationMultipleDay,"create-AllowedDurationPartialDayInd":i.IsAllowedDurationPartialDay,"create-AllowedDurationSingleDayInd":i.IsAllowedDurationSingleDay,"create-approverLevel":i.ApproverLevel,"create-addDelApprovers":i.AddDelApprovers,"create-MultipleApprovers":A,"create-AdditionalFields":p,"create-MultipleApproverFlag":i.IsMultiLevelApproval,"create-readOnlyApprover":i.IsApproverReadOnly,"create-isApproverVisible":i.IsApproverVisible,"create-isNoteVisible":i.IsNoteVisible,"create-showTimePicker":i.IsRecordInClockTimesAllowed,"create-showInputHours":i.IsRecordInClockHoursAllowed,"create-isQuotaCalculated":i.IsQuotaUsed});this._updateLocalModelWithAvailableQuota();},_updateLocalModelWithAvailableQuota:function(){this._updateAvailableQuota();},_uploadAttachments:function(p){var t=this;return new Promise(function(r,R){var A,o,i,j,s,q,v;o=t.byId("AttachmentCollection");A=o.getItems();t._uploadsCompleted=0;t._uploadProgressTotal=A.length;var w=0;A.forEach(function(y){if(y._status!=="display"){w++;}});if(w==0){r({uploadedFiles:i,viewModel:p.viewModel,leavePath:p.leavePath});return;}t._uploadProgressTotal=w;s=t._getAttachmentsUploadUrl();var x=t._updateUploadUrls(A,s);t.oLocalModel.setProperty("/create-uploadPercentage",0.25);i=[];v=function(y){t._uploadsCompleted++;var P=(t._uploadsCompleted/t._uploadProgressTotal*100);t.oLocalModel.setProperty("/create-uploadPercentage",P);i.push({FileName:y.getParameters().files[0].fileName});if(P>=100){o.detachUploadComplete(v);r({uploadedFiles:i,viewModel:p.viewModel,leavePath:p.leavePath});}};o.attachUploadComplete(v);o._aDeletedItemForPendingUpload=[];o.upload();});},_initOverlapCalendar:function(){this.oLocalModel.setProperty("/calendar/assignmentId",this.sCEEmployeeId);if(!this._oOverlapCalendar){this.oLocalModel.setProperty("/calendar/overlapNumber",0);this._oOverlapCalendar=new e({id:"overlapTeamCalendar",applicationId:"MYLEAVEREQUESTS",instanceId:"OVERLAP",assignmentId:"{local>/calendar/assignmentId}",requesterId:"{local>/calendar/assignmentId}",startDate:"{StartDate}",leaveRequestMode:true,leaveRequestSimulateRequest:true,leaveRequestStartDate:"{StartDate}",leaveRequestEndDate:"{EndDate}",leaveRequestDescription:"{i18n>calendarOverlapLeaveRequestText}",dataChanged:function(o){this.oLocalModel.setProperty("/calendar/overlapNumber",o.getParameter("employeeConflictList").length);}.bind(this)});this.getView().addDependent(this._oOverlapCalendar);}},onOverlapOpen:function(){if(!this._overlapDialog){this.getView().removeDependent(this._oOverlapCalendar);this._overlapDialog=new g({title:"{i18n>overlapCalendarLabel}",contentWidth:"1000px",contentHeight:"800px",draggable:true,resizable:true,stretch:D.system.phone,content:[this._oOverlapCalendar],beginButton:[new h({text:"{i18n>calendarOverlapCloseButtonText}",tooltip:"{i18n>calendarOverlapCloseButtonText}",press:function(){this._overlapDialog.close();}.bind(this)})]});this.getView().addDependent(this._overlapDialog);}this._overlapDialog.open();}});});
